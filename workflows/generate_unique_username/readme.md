# Create Unique Okta Usernames


## Overview:

To Onboard users in an organization, IT needs to generate unique usernames for the end users to onboard in downstream systems like Active directory. Also Okta username needs to be unique.

This flow generates unique Okta username: This username is uniquely generated validating against Okta. You can validate this against any public API. At this time of writing Okta does not have an on-premise connector for Workflows. But you can pull the identities in Okta and Workflows can use that for uniqueness checks.

This flow generates username using below logic

lastname(6) characters + firstname (first character). 

If you want to change this logic, Then you can open 002-uniqueUsername flow and modify the first 2 cards.

![image](https://user-images.githubusercontent.com/14205843/92506946-11eacb80-f1bb-11ea-969a-5b23953522e9.png)


## Prerequisites:

1. Access to an Okta tenant with Okta Workflows enabled for your org
2. If you have an attribute level mastering setup - go to profile editor - Edit the Okta profile and click on the username attribute and select inherit from Okta under Master priority.

![image](https://user-images.githubusercontent.com/14205843/91931725-1a15a900-ec99-11ea-846f-784ffc67f5be.png)

3. If you want to create Okta Usernames without any Suffix . For example instead of [krish@test.com](mailto:krish@test.com) you can have Okta username as just Krish. In order to do that in the above screenshot for username change the Format restrictions to none. Default is email. If you use email format as username follow the step in setup instructions.
4. Add preferredfirstName and preferredlastName attributes in Okta profile if you want to use preferredfirstName and lastName over the legal names to generate unique username.
5. You can trigger the flow in two ways. 

a) User create Event: In some cases organization might not want to do import inline hook which is more synchronous, You can use the event hook which is an asynchronous call to endpoint. You can use this option only if you have a way to create a unique username in Okta to trigger the event. Initial Unique username can be derived using user employeeID or some other unique attributes that are generated by the HR system.

b) Import inline hook: Workflow is called during the import process. This is a synchronous call processed during the user import. You need a profile master application in Okta to use an import inline hook.

Enabling import inline hook is documented below. (Also shown in the video or using the below document) . [https://developer.okta.com/docs/reference/import-hook/#enabling-a-user-import-inline-hook](https://developer.okta.com/docs/reference/import-hook/#enabling-a-user-import-inline-hook)

**Note:** Inline hook also supports Link users, If there is an exact match conflict.  `      `


**Design consideration**

Should not use an inline hook if your flow run time is large. When Okta calls your external service, it enforces a default timeout of 3 seconds. Okta will attempt at most one retry. So if your flow is big and going to run for a longer time, you can use the Okta user create event to generate unique username.

**Error handling**:

Error handling can be built inside the logic. For example if there is no firstname or lastName we will error the flow. You can create email notifications or generate tickets in servicenow .


## Setup Steps:

1. Go to the uniqueUsername folder. 

2. If you want to generate Okta username with a domain suffix, Then open the 002-uniqueUsername flow and update the domain name in the assign suffix card. Domain name has to be in this format @test.com. 

![image](https://user-images.githubusercontent.com/14205843/92507145-60986580-f1bb-11ea-9720-ede71f805c78.png)

**Option 1:** Generate unique userName with userCreate event.

1. Open the 001-UserCreate Event in uniqueUsername folder and update the connections
2. In the Okta read user card make sure it shows up the preferredfirstName and PreferredlastName. If not click on the top down arrow icon and hit save, That should give you all the attribute list to choose from.

![image](https://user-images.githubusercontent.com/14205843/91931793-47625700-ec99-11ea-95fb-2aa2688182fb.png)    

3. Open the 002-uniqueUsername and update the Okta connections.
4. Enable all the flows except 001-PRD-inlineHookHandler-V1 
5. Open the read user card
6. If you want to test preferredfirstName and preferredLastname. Make sure those are set as required attributes in Okta. So that when you create a user in the admin console it is populated as a required attribute.

**Option 2**: Inline hook setup steps

**Note: You can also follow the video.**

1. Integrate CSV directory with Okta. You can add the CSV Directory from Directory integrations - Add CSV directory. Alternatively If you have another HR or AD master integration, you can also use that with an inline hook to test end to end workflow. [https://help.okta.com/en/prod/Content/Topics/Directory/csv-integration-get-started.htm](https://help.okta.com/en/prod/Content/Topics/Directory/csv-integration-get-started.htm) 

2. Configure CSV directory in Okta with all the attributes. Go to profile editor - CSV directory and add all the attributes. This should automatically populate all the available attributes based on the CSV file header.

3. Open the 001-PRD-inlineHookHandler-V1 flow which is setup inside the Unique Username folder. 

4.Click on the first card endpoint settings at the bottom and copy the Invoke URL to the import inline hook endpoint settings in Okta. Check the screenshot below

![image](https://user-images.githubusercontent.com/14205843/91931847-6fea5100-ec99-11ea-8fe3-60a98173e49c.png)


5. Now go to Okta and setup the import inline hook from the workflow - Inline hooks. Add user Import inline hook.

![image](https://user-images.githubusercontent.com/14205843/91931878-898b9880-ec99-11ea-94f9-c85a90306eb5.png)

6. You can add a name to the hook and update the endpoint URL from step 6.

![image](https://user-images.githubusercontent.com/14205843/91931958-bcce2780-ec99-11ea-9428-c6ecf28716bb.png)

7. Associate the hook to the profile mastering application. If you use an active directory app or HR app or CSV directory app. Open the application in Okta where you want to setup inline hook. 

8.Go to provisioning tab - to Okta page.

![image](https://user-images.githubusercontent.com/14205843/91931987-d1aabb00-ec99-11ea-9c8c-1d9a73a1f9c9.png)

You should see an inline hook option where you can edit and associate the inline hook.

![image](https://user-images.githubusercontent.com/14205843/91932034-ee46f300-ec99-11ea-9e0d-45908c4b5757.png)


Above should trigger the inline hook during the import process.


## Testing this Flow:

**Option 1**:

If you want to generate usernames using create user events in Okta. Follow below steps.



1. Create a user in Okta. 
2. That should trigger the username generation flow and update Okta username. 

**Option 2**:

If you use an inline hook with directories or as a master app. Follow below steps.

If you have set up the CSV directory. Below is a sample entry you can create.

Below is the sample CSV data.

empID,firstName,lastName,userName,email,emp_status,brandId,managerId

121,Tony,Stark,Tony.stark,tony.stark@gamer.com,active,30104,kvr@jeykrish.com

1. Associate the inline hook with CSV directory.
2. Import the file. This should trigger an inline hook call to the workflows endpoint.
3. Workflow should return the unique username for the user.

**Note**: If you use other directories like active directory or other master app. Make sure you have the inline hook associated with it.

## Limitations & Known Issues:

1. Okta Workflows does not have any on-premise connector at this time for writing. So all the targets should be accessible in public and shall be exposed as an API endpoint.
2. When Okta calls your external service, it enforces a default timeout of 3 seconds. Okta will attempt at most one retry. A request is not retried if the customer endpoint returns a 4xx HTTP error code
